<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MyPythonLab ‚Äî IDLE Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<style>
/* 1. FORCE DARK THEME INSTANTLY (Prevents the white box) */
:root{--bg:#0b1020;--panel:#0f172a;--panel-soft:#111827;--border:#1f2933;--text:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--accent-2:#6366f1;--success:#22c55e;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* 2. HIDE TEXTAREA & GHOST BORDERS */
textarea { background: transparent!important; color: transparent!important; border: none!important; outline: none!important; resize: none; position: absolute; }
.CodeMirror { background: var(--bg)!important; color: var(--text)!important; height: 100%; border: none!important; }
.CodeMirror-gutters { background: var(--panel-soft)!important; border-right: 1px solid var(--border)!important; }
.output { padding:12px; background:#020617; font-family:monospace; flex:1; overflow:auto; white-space:pre-wrap; font-size:14px; color:#cbd5e1; border: none!important; }
.output-input { display:inline-block; outline:none!important; border:none!important; border-bottom: 2px solid var(--accent)!important; color:var(--accent); min-width:15px; padding:0 2px; background:rgba(56,189,248,0.1); }

/* UI Styling */
header{padding:12px 20px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
h1{margin:0;font-size:18px;color:var(--accent); letter-spacing: -0.5px;}
.status{font-size:11px;font-weight:bold;text-transform:uppercase;}
.status.ready{color:var(--success);}
.status.error{color:#f87171;}
.buttons button{margin-left:6px;padding:8px 16px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#020617;font-weight:700;cursor:pointer;}
.buttons button:disabled{opacity:0.3;cursor:not-allowed;}
main{flex:1;padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;overflow:hidden;}
.panel{background:var(--panel-soft);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;}
.panel-header{padding:8px 12px;font-size:11px;font-weight:600;color:var(--muted);border-bottom:1px solid var(--border);background:rgba(0,0,0,0.2);}
@media (max-width:900px){main{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <div><h1>üêç MyPythonLab</h1><span id="status" class="status">Initializing...</span></div>
  <div class="buttons">
    <button id="runBtn" disabled>‚ñ∂ Run</button>
    <button id="stopBtn" disabled>‚èπ Stop</button>
    <button onclick="clearOutput()" style="background:var(--border); color:var(--text);">Clear</button>
  </div>
</header>

<main>
  <div class="panel">
    <div class="panel-header">PYTHON EDITOR (CTRL+ENTER)</div>
    <textarea id="code"></textarea>
  </div>
  <div class="panel">
    <div class="panel-header">CONSOLE OUTPUT</div>
    <div id="output" class="output"></div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>

<script>
const output = document.getElementById("output");
const status = document.getElementById("status");
const runBtn = document.getElementById("runBtn");
const stopBtn = document.getElementById("stopBtn");

function log(msg, color="var(--muted)") { output.innerHTML += `<div style="color:${color}; font-size:12px; margin-bottom:4px;">> ${msg}</div>`; }

// 1. Setup Editor with Dark Theme
const editor = CodeMirror.fromTextArea(document.getElementById("code"), {
  mode: "python", theme: "dracula", lineNumbers: true, indentUnit: 4
});
editor.setValue(localStorage.getItem("mypythonlab_code") |

| `name = input("Name? ")\nprint(f"Hi {name}!")`);
editor.on("change", () => localStorage.setItem("mypythonlab_code", editor.getValue()));

// 2. Shared Memory Logic (Requires Cross-Origin Isolation)
let sab, sInt32, sUint8, worker = null;
function setupMemory() {
  try {
    if (typeof SharedArrayBuffer!== "undefined") {
      sab = new SharedArrayBuffer(1024 * 64); 
      sInt32 = new Int32Array(sab);
      sUint8 = new Uint8Array(sab);
      return true;
    }
  } catch (e) {}
  return false;
}

// 3. User Input Handler
function showInput() {
  const span = document.createElement("span");
  span.className = "output-input";
  span.contentEditable = "true";
  output.appendChild(span);
  span.focus();
  span.onkeydown = (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const val = span.textContent + "\n";
      span.contentEditable = "false";
      span.classList.remove("output-input");
      const bytes = new TextEncoder().encode(val);
      sUint8.set(bytes, 8); // Data starts at offset 8
      sInt32[1] = bytes.length;
      Atomics.store(sInt32, 0, 1); // Wake the worker
      Atomics.notify(sInt32, 0);
      output.appendChild(document.createElement("br"));
    }
  };
}

// 4. Worker Lifecycle
function createWorker() {
  if (worker) worker.terminate();
  const src = `
    importScripts("https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js");
    let pyodide, sInt32, sUint8;
    self.onmessage = async (e) => {
      const { code, sab } = e.data;
      if (sab) { sInt32 = new Int32Array(sab); sUint8 = new Uint8Array(sab); }
      if (!pyodide) {
        pyodide = await loadPyodide();
        pyodide.setStdout({ batched: (s) => self.postMessage({ type: "out", text: s }) });
        pyodide.setStderr({ batched: (s) => self.postMessage({ type: "err", text: s }) });
        pyodide.setStdin({ read(buffer) {
            self.postMessage({ type: "req" });
            Atomics.wait(sInt32, 0, 0); // Worker sleeps here
            const len = sInt32[1];
            buffer.set(sUint8.slice(8, 8 + len));
            Atomics.store(sInt32, 0, 0); 
            return len;
        }});
      }
      try { await pyodide.runPythonAsync(code); } 
      catch (err) { self.postMessage({ type: "err", text: err.toString() }); }
      self.postMessage({ type: "done" });
    };`;
  worker = new Worker(URL.createObjectURL(new Blob([src], {type:"application/javascript"})));
  worker.onmessage = (e) => {
    if (e.data.type === "out") output.innerHTML += `<span>${e.data.text}</span>`;
    if (e.data.type === "err") output.innerHTML += `<span style="color:#f87171">${e.data.text}</span>`;
    if (e.data.type === "req") showInput();
    if (e.data.type === "done") { runBtn.disabled = false; stopBtn.disabled = true; status.textContent = "Ready"; }
  };
}

runBtn.onclick = () => {
  output.innerHTML = "";
  runBtn.disabled = true;
  stopBtn.disabled = false;
  status.textContent = "Running...";
  if (!worker) createWorker();
  worker.postMessage({ code: editor.getValue(), sab: sab });
};

function clearOutput() { output.innerHTML = ""; }
stopBtn.onclick = () => { if (worker) worker.terminate(); worker = null; runBtn.disabled = false; stopBtn.disabled = true; status.textContent = "Ready"; log("Execution Interrupted.", "#f87171"); };

// 5. DIAGNOSTIC BOOT
if (setupMemory()) {
  status.textContent = "Ready";
  status.classList.add("ready");
  runBtn.disabled = false;
  log("System Online. Environment is Cross-Origin Isolated.");
} else {
  status.textContent = "Security Blocked";
  status.classList.add("error");
  log("CRITICAL ERROR: vercel.json headers missing.", "#f87171");
  log("Check that vercel.json is in your ROOT folder and named correctly.", "#f87171");
}

editor.addKeyMap({ "Ctrl-Enter": () => runBtn.onclick(), "Cmd-Enter": () => runBtn.onclick() });
</script>
</body>
</html>
